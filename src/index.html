<!DOCTYPE HTML>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ESP-heatpump</title>
    <style type="text/css">
    </style>
</head>

<body onload="loadWebSocket()">
    <form id="the-form" form action="javascript:;" onsubmit="submitForm(this)"> >
        <label for="user-text">Send something over ws</label>
        <input type="text" id="user-text" name="user_text"><br>
        <input type="submit" id="user-submit" value="Submit" disabled>
    </form>
    <table id="server-resp">
        <tr id="connecting-row"><td>Connecting...</td></tr>
    </table>

    <script type="text/javascript">

        const submitButton = document.getElementById("user-submit");
        const theForm = document.getElementById("the-form");
        const userText = document.getElementById("user-text");
        const serverRespTable = document.getElementById("server-resp");

        var first_connected = false;
        var ws;
        var wsRecvTimer;

        function loadWebSocket() {
            ws = new WebSocket("ws://" + window.location.host + "/ws/uart");
            ws.onopen = function (e) {
                wsRecvTimer = setInterval(wsRecvTimerFunc, 100);
                submitButton.disabled = false;
                if (!first_connected) {
                    document.getElementById("connecting-row").innerHTML = "<td>Connected</td>";
                    first_connected = true;
                } else {
                    let rowconn = serverRespTable.insertRow(0);
                    rowconn.innerHTML = "Reconnected";
                }
                
            };
            ws.onclose = ws.onerror = function (e) {
                clearInterval(wsRecvTimer);
                submitButton.disabled = true;
            };
            ws.onmessage = function (e) {
                console.log(e.data);
                let row = serverRespTable.insertRow(0);
                row.innerText = e.data;
            };
        }

        function submitForm(form) {
            ws.send(form.user_text.value);
        }

        function wsRecvTimerFunc() {
            ws.send("recv?");
        }

    </script>
</body>

</html>